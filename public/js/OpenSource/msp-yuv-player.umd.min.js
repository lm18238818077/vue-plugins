!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MSP_PLAYER=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?e(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function u(e,t,r){return u=l()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&s(i,r.prototype),i},u.apply(null,arguments)}function c(e){var t="function"==typeof Map?new Map:void 0;return c=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return u(e,arguments,a(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,e)},c(e)}function h(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}var f=function(){function e(t){r(this,e),this.canvas=t,this.gl=t.getContext("webgl")||t.getContext("experimental-webgl"),this._init()}return i(e,[{key:"_init",value:function(){var e=this.gl;if(e){e.pixelStorei(e.UNPACK_ALIGNMENT,1);var t=this._compileShader("\n                      attribute lowp vec4 a_vertexPosition;\n                      attribute vec2 a_texturePosition;\n                      varying vec2 v_texCoord;\n                      void main() {\n                          gl_Position = a_vertexPosition;\n                          v_texCoord = a_texturePosition;\n                      }\n                  ",e.VERTEX_SHADER),r=this._compileShader("\n                      precision lowp float;\n                      uniform sampler2D samplerY;\n                      uniform sampler2D samplerU;\n                      uniform sampler2D samplerV;\n                      varying vec2 v_texCoord;\n                      void main() {\n                          float r,g,b,y,u,v,fYmul;\n                          y = texture2D(samplerY, v_texCoord).r;\n                          u = texture2D(samplerU, v_texCoord).r;\n                          v = texture2D(samplerV, v_texCoord).r;\n  \n                          fYmul = y * 1.1643828125;\n                          r = fYmul + 1.59602734375 * v - 0.870787598;\n                          g = fYmul - 0.39176171875 * u - 0.81296875 * v + 0.52959375;\n                          b = fYmul + 2.01723046875 * u - 1.081389160375;\n                          gl_FragColor = vec4(r, g, b, 1.0);\n                      }\n                  ",e.FRAGMENT_SHADER),n=this._createProgram(t,r);this._initVertexBuffers(n),e.activeTexture(e.TEXTURE0),e.y=this._createTexture(),e.uniform1i(e.getUniformLocation(n,"samplerY"),0),e.activeTexture(e.TEXTURE1),e.u=this._createTexture(),e.uniform1i(e.getUniformLocation(n,"samplerU"),1),e.activeTexture(e.TEXTURE2),e.v=this._createTexture(),e.uniform1i(e.getUniformLocation(n,"samplerV"),2)}else console.log("gl not supportÔºÅ")}},{key:"_initVertexBuffers",value:function(e){var t=this.gl,r=t.createBuffer(),n=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0]);t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);var i=t.getAttribLocation(e,"a_vertexPosition");t.vertexAttribPointer(i,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i);var o=new Float32Array([1,0,0,0,1,1,0,1]),a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW);var s=t.getAttribLocation(e,"a_texturePosition");t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(s)}},{key:"_compileShader",value:function(e,t){var r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){var n=this.gl.getShaderInfoLog(r);return this.gl.deleteShader(r),void console.error("could not compile shader",n)}return r}},{key:"_createProgram",value:function(e,t){var r=this.gl,n=r.createProgram();if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),r.useProgram(n),this.gl.getProgramParameter(n,this.gl.LINK_STATUS))return n;console.err("program fail to link"+this.gl.getShaderInfoLog(n))}},{key:"_createTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.gl.LINEAR,t=this.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r}},{key:"renderImg",value:function(e,t,r){var n=this.gl;n.viewport(0,0,n.canvas.width,n.canvas.height),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT);var i=e*t,o=(e>>1)*(t>>1);n.bindTexture(n.TEXTURE_2D,n.y),n.texImage2D(n.TEXTURE_2D,0,n.LUMINANCE,e,t,0,n.LUMINANCE,n.UNSIGNED_BYTE,r.subarray(0,i)),n.bindTexture(n.TEXTURE_2D,n.u),n.texImage2D(n.TEXTURE_2D,0,n.LUMINANCE,e>>1,t>>1,0,n.LUMINANCE,n.UNSIGNED_BYTE,r.subarray(i,i+o)),n.bindTexture(n.TEXTURE_2D,n.v),n.texImage2D(n.TEXTURE_2D,0,n.LUMINANCE,e>>1,t>>1,0,n.LUMINANCE,n.UNSIGNED_BYTE,r.subarray(i+o,r.length)),n.drawArrays(n.TRIANGLE_STRIP,0,4)}},{key:"setSize",value:function(e,t,r){var n=Math.min(r,e);this.canvas.width=n,this.canvas.height=n*t/e}},{key:"destroy",value:function(){var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.getExtension("WEBGL_lose_context").loseContext()}}]),e}(),d="‰∏ªÂä®ÂÖ≥Èó≠",p=4444,v=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r(this,e);var o=new WebSocket(t);o.binaryType="arraybuffer",this.wsURL=t;var a=i.glWidth,s=i.glHeight;this.ws=o,this.gl=n,this.glWidth=a,this.glHeight=s,this.renderStatus=1,this.dataStatus=0,this.yuvData=null,this.reconnectTimer=1,this.reconnectTimerMax=3,this.reconnectTimerDelay=3e3,o&&this._wsInit()}return i(e,[{key:"_wsInit",value:function(){var e=this;this.ws.onopen=function(){console.info("üôÇ---wsÈìæÊé•---open")},this.ws.onclose=function(t){var r=t.code,n=t.reason;console.info("üòë---wsÈìæÊé•---close"),r!==p&&n!==d&&e.reconnectWS()},this.ws.onmessage=function(t){0!==e.renderStatus&&(e.yuvData=new Uint8Array(t.data),e.gl.renderImg(e.glWidth,e.glHeight,e.yuvData))},this.ws.onerror=function(t){console.info("üò≠---wsÈìæÊé•---error",t),e.reconnectWS()}}},{key:"closeWS",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d;this.ws.close(e,t),this.ws=null,this.gl.destroy()}},{key:"setWsStatus",value:function(e){[0,1].includes(e)&&this.renderStatus!==e&&(this.renderStatus=e)}},{key:"reconnectWS",value:function(){var e=this;if(this.reconnectTimer>this.reconnectTimerMax)return console.error("„ÄêERROR„Äë---WebSocketÈìæÊé•ÈîôËØØ",this.wsURL);setTimeout((function(){e.reconnectTimer++,e.ws=new WebSocket(e.wsURL),e._wsInit()}),this.reconnectTimerDelay)}}]),e}(),y=function(){var e,t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(n=n||i.length,r)for(e=0;e<r;e++)o[e]=i[0|Math.random()*n];else for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",e=0;e<36;e++)o[e]||(t=0|16*Math.random(),o[e]=i[19==e?3&t|8:t]);return o.join("")},g="yuv-player",T=function(){var e=document.createElement("template");e.innerHTML='\n  <style>\n    .msp-player-box {\n      width: 100%;\n      height: 100%;\n      display: flex;\n      position: relative;\n      cursor: pointer;\n    }  \n  </style>\n\n  <div class="msp-player-box" id="msp-player-box">\n    <slot>Âç†‰Ωç</slot>\n  </div>\n';var t=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(u,t);var n,i,o=(n=u,i=l(),function(){var e,t=a(n);if(i){var r=a(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return h(this,e)});function u(){var t;return r(this,u),(t=o.call(this))._shadowRoot=t.attachShadow({mode:"open"}),t._shadowRoot.appendChild(e.content.cloneNode(!0)),t}return u}(c(HTMLElement));window.customElements.define(g,t)},_={},m=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{autoPlay:!0};r(this,e);var n=t.wsUrl,i=t.autoPlay,o=t.el,a=t.sharpType,s=void 0===a?_:a,l=t.cid;if(console.info("üöÄMSP_PLAYER.CONFIG",t),this.cid=Number(l),null==s||!s.width||null==s||!s.height)return new Error("„ÄêÂàùÂßãÂåñplayerÂèÇÊï∞ÈîôËØØ„Äë--ËØ∑‰º†ÂÖ•Ê≠£Á°ÆsharpType = { width, height } ÂÆΩÈ´òÈÖçÁΩÆÔºÅ");this._bridgeWidthToSharpType(s,!1),void 0===i&&(i=!0),e.initPlayerTemplate(),this.wsUrl=n,this.canvas_id=y(),this.playerWS=null,this.playStatus=0,this.statusTips="Âç≥Â∞ÜÂºÄÂßãËá™Âä®Êí≠Êîæ...",this.mountDom=o,this.gl=null,this._mountPlayer(),this._initCanvasGl(),i&&this.play()}return i(e,[{key:"play",value:function(){this.playerWS?this.playerWS.setWsStatus(1):this._initPlayerWs()}},{key:"pause",value:function(){this.playerWS.setWsStatus(0)}},{key:"stop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.playerWS.closeWS(),this.playerWS=null,e&&this._notifyMspClose(e)}},{key:"_notifyMspClose",value:function(e){if(this.cid)try{var t,r,n,i=window.cloudICP,o={cid:String(this.cid),callback:function(t){e(t)}};null===(t=i.dispatch)||void 0===t||null===(r=t.video)||void 0===r||null===(n=r.release)||void 0===n||n.call(r,o)}catch(e){console.error("[Error] - Ë∞ÉÁî®cloudICP.dispatch.video.releaseÂá∫Èîô",e)}}},{key:"changeVideResolution",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=""==t||null==t||null==t;if(console.info("changeVideResolution.sharpType",t),r)return console.warn("„ÄêchangeVideResolutionÊîπÂèòÂàÜËæ®Áéá ÂèÇÊï∞ÈîôËØØ„ÄëÔºöËØ∑ËæìÂÖ•Ê≠£Á°ÆÂèÇÊï∞ÔºåÂ¶ÇÔºö { width: 1920, height: 1080 }");if(this.playerWS){//! ÊîπÁâàÊñπÊ°àÔºåËÆ©‰∫åÂºÄ‰º†ÂÖ•ÂÆΩ„ÄÅÈ´òÔºå‰ªéËÄåÂéªËÆæÁΩÆÁõ∏ÂÖ≥ÂàÜËæ®ÁéáÔºåÁÑ∂ÂêéË∞ÉÁî®Êé•Âè£ÈÄöÁü•MSPÔºàÊ≠§Êó∂ÔºåÈúÄË¶ÅÂàùÂßãÂåñÊó∂‰º†ÂÖ•cidÔºâ
this.playerWS.setWsStatus(0);var n=500,i=function(){setTimeout((function(){e.playerWS.glWidth=e.playerWidth,e.playerWS.glHeight=e.playerHeight,e._setCanvasSize(),e.playerWS.setWsStatus(1)}),n)};if(null==t||!t.width||null==t||!t.height)return new Error("„ÄêÂàùÂßãÂåñplayerÂèÇÊï∞ÈîôËØØ„Äë--ËØ∑‰º†ÂÖ•Ê≠£Á°ÆsharpType = { width, height } ÂÆΩÈ´òÈÖçÁΩÆÔºÅ");this._bridgeWidthToSharpType(t,!0,i)}}},{key:"_bridgeWidthToSharpType",value:function(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=parseInt(e.width),o=parseInt(e.height);i>1920&&(i=1920),o>1080&&(o=1080);var a=function(e,t){var r={},n=parseInt(e*(9/16)),i=parseInt(t*(16/9));return n<=t?(r.width=e,r.height=n):i<=e&&(r.width=i,r.height=t),r.width%4!=0&&(r.width=r.width+(4-r.width%4)),r.height%4!=0&&(r.height=r.height+(4-r.height%4)),r},s=a(i,o);if(this._setMediaQUality(s),r){if(!this.cid)return console.warn("‚ö†‚ö† ËØ∑Âú®ÂàùÂßãÂåñplayerÊó∂‰º†ÂÖ•cid!");try{var l,u,c,h=window.cloudICP,f=t(t({},e),{},{resID:this.cid,callback:n});null===(l=h.dispatch)||void 0===l||null===(u=l.video)||void 0===u||null===(c=u.setWssflowWinFmttype)||void 0===c||c.call(u,f)}catch(e){console.error("[Error] - Ë∞ÉÁî®cloudICP.dispatch.video.setWssflowWinFmttypeÂá∫Èîô",e)}}}},{key:"_initCanvasGl",value:function(){var e=document.getElementById(this.canvas_id),t=new f(e);this.gl=t,this._setCanvasSize()}},{key:"_setCanvasSize",value:function(){this.gl.setSize(this.playerWidth,this.playerHeight,this.playerWidth)}},{key:"_initPlayerWs",value:function(){var e={glWidth:this.playerWidth,glHeight:this.playerHeight},t=new v(this.wsUrl,this.gl,e);this.playerWS=t}},{key:"_setMediaQUality",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.width,r=void 0===t?1280:t,n=e.height,i=void 0===n?720:n;this.playerWidth=r,this.playerHeight=i}},{key:"_mountPlayer",value:function(){var e='<yuv-player><canvas id="'.concat(this.canvas_id,'" style="width: 100%;height: 100%;" width="1280" height="720"></canvas></yuv-player>');this.mountDom.innerHTML=e}},{key:"setStatusTips",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e&&(this.statusTips=e)}},{key:"_setPlayStatus",value:function(e){[-1,0,1].includes(e)&&(this.playStatus=e)}}],[{key:"genID",value:function(e){return Number(Math.random().toString().substr(3,e)+Date.now()).toString(36)}},{key:"initPlayerTemplate",value:function(){var e;(e=g,window.customElements.get(e))||T()}}]),e}();return m}));
